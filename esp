local Workspace, RunService, Players, CoreGui, Lighting = cloneref(game:GetService("Workspace")), cloneref(game:GetService("RunService")), cloneref(game:GetService("Players")), game:GetService("CoreGui"), cloneref(game:GetService("Lighting"))

local esp = {
    enabled = true,
    box = true,
    name = true,
    distance = true,
    weapon = true,
    healthbar = true,
    healthtext = true,
    chams = true,
    glow = true,
    maxdistance = 200,
    fontsize = 11,
    teamcheck = true,
    box_filled = true,
    box_fill_gradient = true,
    box_gradient = true,
    box_corner = false,
    healthbar_gradient = true,
    healthbar_gradient_lerp = false,
    healthbar_healthtext = true,
    healthbar_width = 2.5,
    box_animate = false,
    box_rotation_speed = 300,
    box_fill_gradient_color1 = Color3.fromRGB(0, 0, 0),
    box_fill_gradient_color2 = Color3.fromRGB(0, 255, 0),
    box_gradient_color1 = Color3.fromRGB(0, 0, 0),
    box_gradient_color2 = Color3.fromRGB(0, 255, 0),
    healthbar_gradient_color1 = Color3.fromRGB(255, 0, 0),
    healthbar_gradient_color2 = Color3.fromRGB(255, 255, 0),
    healthbar_gradient_color3 = Color3.fromRGB(0, 255, 0),
    healthbar_healthtext_color = Color3.fromRGB(119, 120, 255),
    weapon_color = Color3.fromRGB(119, 120, 255),
    corner_color = Color3.fromRGB(255, 255, 255),
    chams_color = Color3.fromRGB(0, 0, 0),
    glow_color = Color3.fromRGB(255, 255, 255),
    chams_transparency = 0.5,
    friendcheck = true,
    friendcheck_color = Color3.fromRGB(0, 255, 0),
    distance_position = "Bottom",
}

-- Def & Vars
local lplayer = Players.LocalPlayer
local Cam = Workspace.CurrentCamera
local RotationAngle, Tick = -45, tick()

-- Functions
local Functions = {}
do
    function Functions:Create(Class, Properties)
        local _Instance = typeof(Class) == 'string' and Instance.new(Class) or Class
        for Property, Value in pairs(Properties) do
            _Instance[Property] = Value
        end
        return _Instance
    end
    function getool(char)
        if char then
            local tool = char:FindFirstChildOfClass("Tool")
            if tool then
                return tool.Name
            end
        end
        return "None"
    end
end

do -- Initialize
    local ScreenGui = Functions:Create("ScreenGui", {
        Parent = CoreGui,
        Name = "ESPHolder",
    })

    local DupeCheck = function(plr)
        if ScreenGui:FindFirstChild(plr.Name) then
            ScreenGui[plr.Name]:Destroy()
        end
    end

    local ESP = function(plr)
        coroutine.wrap(DupeCheck)(plr)
        local Name = Functions:Create("TextLabel", {Parent = ScreenGui, Position = UDim2.new(0.5, 0, 0, -11), Size = UDim2.new(0, 100, 0, 20), AnchorPoint = Vector2.new(0.5, 0.5), BackgroundTransparency = 1, TextColor3 = Color3.fromRGB(255, 255, 255), Font = Enum.Font.Code, TextSize = esp.fontsize, TextStrokeTransparency = 0, TextStrokeColor3 = Color3.fromRGB(0, 0, 0), RichText = true})
        local Distance = Functions:Create("TextLabel", {Parent = ScreenGui, Position = UDim2.new(0.5, 0, 0, 11), Size = UDim2.new(0, 100, 0, 20), AnchorPoint = Vector2.new(0.5, 0.5), BackgroundTransparency = 1, TextColor3 = Color3.fromRGB(255, 255, 255), Font = Enum.Font.Code, TextSize = esp.fontsize, TextStrokeTransparency = 0, TextStrokeColor3 = Color3.fromRGB(0, 0, 0), RichText = true})
        local Weapon = Functions:Create("TextLabel", {Parent = ScreenGui, Position = UDim2.new(0.5, 0, 0, 31), Size = UDim2.new(0, 100, 0, 20), AnchorPoint = Vector2.new(0.5, 0.5), BackgroundTransparency = 1, TextColor3 = esp.weapon_color, Font = Enum.Font.Code, TextSize = esp.fontsize, TextStrokeTransparency = 0, TextStrokeColor3 = Color3.fromRGB(0, 0, 0), RichText = true})
        local Box = Functions:Create("Frame", {Parent = ScreenGui, BackgroundColor3 = Color3.fromRGB(0, 0, 0), BackgroundTransparency = 0.75, BorderSizePixel = 0})
        local Gradient1 = Functions:Create("UIGradient", {Parent = Box, Enabled = esp.box_fill_gradient, Color = ColorSequence.new{ColorSequenceKeypoint.new(0, esp.box_fill_gradient_color1), ColorSequenceKeypoint.new(1, esp.box_fill_gradient_color2)}})
        local Outline = Functions:Create("UIStroke", {Parent = Box, Enabled = esp.box_gradient, Transparency = 0, Color = Color3.fromRGB(255, 255, 255), LineJoinMode = Enum.LineJoinMode.Miter})
        local Gradient2 = Functions:Create("UIGradient", {Parent = Outline, Enabled = esp.box_gradient, Color = ColorSequence.new{ColorSequenceKeypoint.new(0, esp.box_gradient_color1), ColorSequenceKeypoint.new(1, esp.box_gradient_color2)}})
        local Healthbar = Functions:Create("Frame", {Parent = ScreenGui, BackgroundColor3 = Color3.fromRGB(255, 255, 255), BackgroundTransparency = 0})
        local BehindHealthbar = Functions:Create("Frame", {Parent = ScreenGui, ZIndex = -1, BackgroundColor3 = Color3.fromRGB(0, 0, 0), BackgroundTransparency = 0})
        local HealthbarGradient = Functions:Create("UIGradient", {Parent = Healthbar, Enabled = esp.healthbar_gradient, Rotation = -90, Color = ColorSequence.new{ColorSequenceKeypoint.new(0, esp.healthbar_gradient_color1), ColorSequenceKeypoint.new(0.5, esp.healthbar_gradient_color2), ColorSequenceKeypoint.new(1, esp.healthbar_gradient_color3)}})
        local HealthText = Functions:Create("TextLabel", {Parent = ScreenGui, Position = UDim2.new(0.5, 0, 0, 31), Size = UDim2.new(0, 100, 0, 20), AnchorPoint = Vector2.new(0.5, 0.5), BackgroundTransparency = 1, TextColor3 = esp.healthbar_healthtext_color, Font = Enum.Font.Code, TextSize = esp.fontsize, TextStrokeTransparency = 0, TextStrokeColor3 = Color3.fromRGB(0, 0, 0)})
        local LeftTop = Functions:Create("Frame", {Parent = ScreenGui, BackgroundColor3 = esp.corner_color, Position = UDim2.new(0, 0, 0, 0), BorderSizePixel = 0})
        local LeftSide = Functions:Create("Frame", {Parent = ScreenGui, BackgroundColor3 = esp.corner_color, Position = UDim2.new(0, 0, 0, 0), BorderSizePixel = 0})
        local RightTop = Functions:Create("Frame", {Parent = ScreenGui, BackgroundColor3 = esp.corner_color, Position = UDim2.new(0, 0, 0, 0), BorderSizePixel = 0})
        local RightSide = Functions:Create("Frame", {Parent = ScreenGui, BackgroundColor3 = esp.corner_color, Position = UDim2.new(0, 0, 0, 0), BorderSizePixel = 0})
        local BottomSide = Functions:Create("Frame", {Parent = ScreenGui, BackgroundColor3 = esp.corner_color, Position = UDim2.new(0, 0, 0, 0), BorderSizePixel = 0})
        local BottomDown = Functions:Create("Frame", {Parent = ScreenGui, BackgroundColor3 = esp.corner_color, Position = UDim2.new(0, 0, 0, 0), BorderSizePixel = 0})
        local BottomRightSide = Functions:Create("Frame", {Parent = ScreenGui, BackgroundColor3 = esp.corner_color, Position = UDim2.new(0, 0, 0, 0), BorderSizePixel = 0})
        local BottomRightDown = Functions:Create("Frame", {Parent = ScreenGui, BackgroundColor3 = esp.corner_color, Position = UDim2.new(0, 0, 0, 0), BorderSizePixel = 0})
        local Flag1 = Functions:Create("TextLabel", {Parent = ScreenGui, Position = UDim2.new(1, 0, 0, 0), Size = UDim2.new(0, 100, 0, 20), AnchorPoint = Vector2.new(0.5, 0.5), BackgroundTransparency = 1, TextColor3 = Color3.fromRGB(255, 255, 255), Font = Enum.Font.Code, TextSize = esp.fontsize, TextStrokeTransparency = 0, TextStrokeColor3 = Color3.fromRGB(0, 0, 0)})
        local Flag2 = Functions:Create("TextLabel", {Parent = ScreenGui, Position = UDim2.new(1, 0, 0, 0), Size = UDim2.new(0, 100, 0, 20), AnchorPoint = Vector2.new(0.5, 0.5), BackgroundTransparency = 1, TextColor3 = Color3.fromRGB(255, 255, 255), Font = Enum.Font.Code, TextSize = esp.fontsize, TextStrokeTransparency = 0, TextStrokeColor3 = Color3.fromRGB(0, 0, 0)})

        local Updater = function()
            local Connection
            local function HideESP()
                Box.Visible = false
                Name.Visible = false
                Distance.Visible = false
                Weapon.Visible = false
                Healthbar.Visible = false
                BehindHealthbar.Visible = false
                HealthText.Visible = false
                LeftTop.Visible = false
                LeftSide.Visible = false
                BottomSide.Visible = false
                BottomDown.Visible = false
                RightTop.Visible = false
                RightSide.Visible = false
                BottomRightSide.Visible = false
                BottomRightDown.Visible = false
                Flag1.Visible = false
                Flag2.Visible = false
                if not plr then
                    ScreenGui:Destroy()
                    Connection:Disconnect()
                end
            end

            Connection = RunService.RenderStepped:Connect(function()
                if plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                    local HRP = plr.Character.HumanoidRootPart
                    local Humanoid = plr.Character:WaitForChild("Humanoid")
                    local Pos, OnScreen = Cam:WorldToScreenPoint(HRP.Position)
                    local Dist = (Cam.CFrame.Position - HRP.Position).Magnitude / 3.5714285714

                    if OnScreen and Dist <= esp.maxdistance then
                        local Size = HRP.Size.Y
                        local scaleFactor = (Size * Cam.ViewportSize.Y) / (Pos.Z * 2)
                        local w, h = 3 * scaleFactor, 4.5 * scaleFactor

                        if esp.teamcheck and plr ~= lplayer and ((lplayer.Team ~= plr.Team and plr.Team) or (not lplayer.Team and not plr.Team)) and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") and plr.Character:FindFirstChild("Humanoid") then

                            do -- Corner Boxes
                                LeftTop.Visible = esp.box_corner
                                LeftTop.Position = UDim2.new(0, Pos.X - w / 2, 0, Pos.Y - h / 2)
                                LeftTop.Size = UDim2.new(0, w / 5, 0, 1)

                                LeftSide.Visible = esp.box_corner
                                LeftSide.Position = UDim2.new(0, Pos.X - w / 2, 0, Pos.Y - h / 2)
                                LeftSide.Size = UDim2.new(0, 1, 0, h / 5)

                                BottomSide.Visible = esp.box_corner
                                BottomSide.Position = UDim2.new(0, Pos.X - w / 2, 0, Pos.Y + h / 2)
                                BottomSide.Size = UDim2.new(0, 1, 0, h / 5)
                                BottomSide.AnchorPoint = Vector2.new(0, 1)

                                BottomDown.Visible = esp.box_corner
                                BottomDown.Position = UDim2.new(0, Pos.X - w / 2, 0, Pos.Y + h / 2)
                                BottomDown.Size = UDim2.new(0, w / 5, 0, 1)
                                BottomDown.AnchorPoint = Vector2.new(0, 1)

                                RightTop.Visible = esp.box_corner
                                RightTop.Position = UDim2.new(0, Pos.X + w / 2, 0, Pos.Y - h / 2)
                                RightTop.Size = UDim2.new(0, w / 5, 0, 1)
                                RightTop.AnchorPoint = Vector2.new(1, 0)

                                RightSide.Visible = esp.box_corner
                                RightSide.Position = UDim2.new(0, Pos.X + w / 2 - 1, 0, Pos.Y - h / 2)
                                RightSide.Size = UDim2.new(0, 1, 0, h / 5)
                                RightSide.AnchorPoint = Vector2.new(0, 0)

                                BottomRightSide.Visible = esp.box_corner
                                BottomRightSide.Position = UDim2.new(0, Pos.X + w / 2, 0, Pos.Y + h / 2)
                                BottomRightSide.Size = UDim2.new(0, 1, 0, h / 5)
                                BottomRightSide.AnchorPoint = Vector2.new(1, 1)

                                BottomRightDown.Visible = esp.box_corner
                                BottomRightDown.Position = UDim2.new(0, Pos.X + w / 2, 0, Pos.Y + h / 2)
                                BottomRightDown.Size = UDim2.new(0, w / 5, 0, 1)
                                BottomRightDown.AnchorPoint = Vector2.new(1, 1)
                            end

                            do -- Boxes
                                Box.Position = UDim2.new(0, Pos.X - w / 2, 0, Pos.Y - h / 2)
                                Box.Size = UDim2.new(0, w, 0, h)
                                Box.Visible = esp.box

                                if esp.box_filled then
                                    Box.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
                                    if esp.box_fill_gradient then
                                        Box.BackgroundTransparency = 0.75
                                    else
                                        Box.BackgroundTransparency = 1
                                    end
                                    Box.BorderSizePixel = 1
                                else
                                    Box.BackgroundTransparency = 1
                                end

                                RotationAngle = RotationAngle + (tick() - Tick) * esp.box_rotation_speed * math.cos(math.pi / 4 * tick() - math.pi / 2)
                                if esp.box_animate then
                                    Gradient1.Rotation = RotationAngle
                                    Gradient2.Rotation = RotationAngle
                                else
                                    Gradient1.Rotation = 90
                                    Gradient2.Rotation = 90
                                end
                                Tick = tick()
                            end

                            do -- Healthbar
                                local health = Humanoid.Health / Humanoid.MaxHealth
                                Healthbar.Visible = esp.healthbar
                                Healthbar.Position = UDim2.new(0, Pos.X - w / 2 - 6, 0, Pos.Y - h / 2 + h * (1 - health))
                                Healthbar.Size = UDim2.new(0, esp.healthbar_width, 0, h * health)
                                BehindHealthbar.Visible = esp.healthbar
                                BehindHealthbar.Position = UDim2.new(0, Pos.X - w / 2 - 6, 0, Pos.Y - h / 2)
                                BehindHealthbar.Size = UDim2.new(0, esp.healthbar_width, 0, h)

                                if esp.healthbar_healthtext then
                                    local healthPercentage = math.floor(Humanoid.Health / Humanoid.MaxHealth * 100)
                                    HealthText.Position = UDim2.new(0, Pos.X - w / 2 - 6, 0, Pos.Y - h / 2 + h * (1 - healthPercentage / 100) + 3)
                                    HealthText.Text = tostring(healthPercentage)
                                    HealthText.Visible = Humanoid.Health < Humanoid.MaxHealth
                                    if esp.healthbar_gradient_lerp then
                                        local color = health >= 0.75 and Color3.fromRGB(0, 255, 0) or health >= 0.5 and Color3.fromRGB(255, 255, 0) or health >= 0.25 and Color3.fromRGB(255, 170, 0) or Color3.fromRGB(255, 0, 0)
                                        HealthText.TextColor3 = color
                                    else
                                        HealthText.TextColor3 = esp.healthbar_healthtext_color
                                    end
                                end
                            end

                            do -- Names
                                Name.Visible = esp.name
                                if esp.friendcheck and lplayer:IsFriendsWith(plr.UserId) then
                                    Name.Text = plr.Name
                                    Name.TextColor3 = Color3.fromRGB(0, 170, 255)
                                else
                                    Name.Text = plr.Name
                                end
                                Name.Position = UDim2.new(0, Pos.X, 0, Pos.Y - h / 2 - 9)
                            end

                            do -- Distance
                                if esp.distance then
                                    if esp.distance_position == "Bottom" then
                                        Weapon.Position = UDim2.new(0, Pos.X, 0, Pos.Y + h / 2 + 18)
                                        Distance.Position = UDim2.new(0, Pos.X, 0, Pos.Y + h / 2 + 7)
                                        Distance.Text = string.format("%dM", math.floor(Dist))
                                        Distance.Visible = true
                                    elseif esp.distance_position == "Text" then
                                        Weapon.Position = UDim2.new(0, Pos.X, 0, Pos.Y + h / 2 + 8)
                                        Distance.Visible = false
                                        if esp.friendcheck and lplayer:IsFriendsWith(plr.UserId) then
                                            Name.Text = string.format('(<font color="rgb(%d, %d, %d)">F</font>) %s [%d]', esp.friendcheck_color.R * 255, esp.friendcheck_color.G * 255, esp.friendcheck_color.B * 255, plr.Name, math.floor(Dist))
                                        else
                                            Name.Text = string.format('(<font color="rgb(%d, %d, %d)">E</font>) %s [%d]', 255, 0, 0, plr.Name, math.floor(Dist))
                                        end
                                        Name.Visible = esp.name
                                    end
                                end
                            end

                            do -- Weapons
                                Weapon.Text = getool(plr.Character)
                                Weapon.Visible = esp.weapon
                            end
                        else
                            HideESP()
                        end
                    else
                        HideESP()
                    end
                else
                    HideESP()
                end
            end)
        end
        coroutine.wrap(Updater)()
    end

    do -- Update ESP
        for _, v in pairs(game:GetService("Players"):GetPlayers()) do
            if v.Name ~= lplayer.Name then
                coroutine.wrap(ESP)(v)
            end
        end
        game:GetService("Players").PlayerAdded:Connect(function(v)
            coroutine.wrap(ESP)(v)
        end)
    end
end

local InstanceNew, CFrameNew, Vec3 = Instance.new, CFrame.new, Vector3.new

pcall(function() setfflag("AdornShadingAPI", "true") end)

do
    local function RemoveAdorns(Part)
        if not Part then return end;
        local Children = Part:GetChildren();

        for i = 1, #Children do
            local Obj = Children[i]
            if Obj.Name == "Chams" or Obj.Name == "Glow" then
                Obj:Destroy();
            end
        end
    end

    function CreateAdornment(Part, Type, Color, Trans, ZIndex, SizeOffset, Extra)
        Extra = Extra or {}

        local Ad
        if Type == "Cylinder" then
            Ad = InstanceNew("CylinderHandleAdornment")
            Ad.Height = Part.Size.Y + (Extra.HeightOffset or 0);
            Ad.Radius = (Part.Size.X * 0.5) + (Extra.RadiusOffset or 0);
            Ad.CFrame = CFrameNew(Vec3(), Vec3(0, 1, 0));

        elseif Type == "Box" then
            Ad = InstanceNew("BoxHandleAdornment")
            Ad.Size = Part.Size + (SizeOffset or Vec3(0,0,0));
        end

        Ad.Name = "Chams"
        Ad.AlwaysOnTop = true
        Ad.ZIndex = ZIndex
        Ad.Adornee = Part
        Ad.Color3 = Color
        Ad.Transparency = Trans or 0
        if Extra.Shading then
            Ad.Shading = Extra.Shading
        end

        Ad.Parent = Part
        return Ad
    end

    task.spawn(function()
        while task.wait(2) do
            local MainColor = esp.chams_color;
            local GlowColor = esp.glow_color;
            local Trans = esp.chams_transparency

            for _, Player in Players:GetPlayers() do
                if Player == lplayer then continue end
                local Char = Player.Character
                if not Char then continue end

                for _, Part in Char:GetChildren() do
                    if not Part:IsA("BasePart") or Part.Transparency >= 1 then continue end;

                    RemoveAdorns(Part)

                    local IsHead = Part.Name == "Head" or Part.Name == "FakeHead"

                    if esp.glow then
                        CreateAdornment(
                            Part,
                            IsHead and "Cylinder" or "Box",
                            Color3.new(GlowColor.R*5, GlowColor.G*5, GlowColor.B*5),
                            -1,
                            IsHead and 10 or 9,
                            Vec3(0.03, 0.03, 0.03),
                            { Shading = Enum.AdornShading.XRayShaded }
                        )
                    end

                    if esp.chams then
                        CreateAdornment(
                            Part,
                            IsHead and "Cylinder" or "Box",
                            MainColor,
                            Trans,
                            10,
                            Vec3(0.02, 0.02, 0.02)
                        )
                    end
                end
            end
        end
    end)
end;
